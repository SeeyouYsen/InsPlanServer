# InsPlan å¾®æœåŠ¡ç®¡ç† Makefile

.PHONY: help build start stop clean test logs health deploy-k8s

# é»˜è®¤ç›®æ ‡
help:
	@echo "InsPlan å¾®æœåŠ¡ç®¡ç†å‘½ä»¤"
	@echo "======================="
	@echo "build       - æ„å»ºæ‰€æœ‰æœåŠ¡é•œåƒ"
	@echo "start       - å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "stop        - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "restart     - é‡å¯æ‰€æœ‰æœåŠ¡"
	@echo "clean       - æ¸…ç†å®¹å™¨å’Œé•œåƒ"
	@echo "test        - è¿è¡Œ API æµ‹è¯•"
	@echo "logs        - æŸ¥çœ‹æœåŠ¡æ—¥å¿—"
	@echo "health      - æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€"
	@echo "deploy-k8s  - éƒ¨ç½²åˆ° Kubernetes"
	@echo "scale       - æ‰©å±•æœåŠ¡å®ä¾‹"
	@echo "monitoring  - å¯åŠ¨ç›‘æ§æœåŠ¡"

# æ„å»ºæ‰€æœ‰æœåŠ¡
build:
	@echo "ğŸ”¨ æ„å»ºæ‰€æœ‰æœåŠ¡é•œåƒ..."
	@docker-compose build

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
start:
	@echo "ğŸš€ å¯åŠ¨æ‰€æœ‰æœåŠ¡..."
	@docker-compose up -d

# åœæ­¢æ‰€æœ‰æœåŠ¡
stop:
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡..."
	@docker-compose down

# é‡å¯æ‰€æœ‰æœåŠ¡
restart: stop start

# æ¸…ç†å®¹å™¨å’Œé•œåƒ
clean:
	@echo "ğŸ§¹ æ¸…ç†å®¹å™¨å’Œé•œåƒ..."
	@docker-compose down -v --rmi all --remove-orphans
	@docker system prune -f

# è¿è¡Œ API æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œ API æµ‹è¯•..."
	@chmod +x ./test-apis.sh
	@./test-apis.sh

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
logs:
	@echo "ğŸ“‹ æŸ¥çœ‹æœåŠ¡æ—¥å¿—..."
	@docker-compose logs -f

# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
health:
	@echo "ğŸ’“ æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
	@echo "API Gateway: " && curl -s http://localhost:8080/health | jq .
	@echo "User Service: " && curl -s http://localhost:8001/health | jq .
	@echo "Plan Service: " && curl -s http://localhost:8002/health | jq .
	@echo "Order Service: " && curl -s http://localhost:8083/health | jq .
	@echo "Payment Service: " && curl -s http://localhost:8003/health | jq .
	@echo "Notification Service: " && curl -s http://localhost:8004/health | jq .

# éƒ¨ç½²åˆ° Kubernetes
deploy-k8s:
	@echo "â˜¸ï¸ éƒ¨ç½²åˆ° Kubernetes..."
	@kubectl apply -f infrastructure/kubernetes/deployment.yaml

# æ‰©å±•æœåŠ¡å®ä¾‹
scale:
	@echo "ğŸ“ˆ æ‰©å±•æœåŠ¡å®ä¾‹..."
	@docker-compose up --scale user-service=3 --scale plan-service=2 --scale order-service=2 -d

# å¯åŠ¨ç›‘æ§æœåŠ¡
monitoring:
	@echo "ğŸ“Š å¯åŠ¨ç›‘æ§æœåŠ¡..."
	@docker-compose up -d prometheus grafana elasticsearch logstash kibana

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
logs-user:
	@docker-compose logs -f user-service

logs-plan:
	@docker-compose logs -f plan-service

logs-order:
	@docker-compose logs -f order-service

logs-payment:
	@docker-compose logs -f payment-service

logs-notification:
	@docker-compose logs -f notification-service

logs-gateway:
	@docker-compose logs -f api-gateway

# æ•°æ®åº“è¿ç§»
migrate:
	@echo "ğŸ—ƒï¸ è¿è¡Œæ•°æ®åº“è¿ç§»..."
	@docker-compose exec user-service ./UserService migrate --yes
	@docker-compose exec plan-service ./PlanService migrate --yes
	@docker-compose exec order-service ./OrderService migrate --yes
	@docker-compose exec payment-service ./PaymentService migrate --yes
	@docker-compose exec notification-service ./NotificationService migrate --yes

# å¤‡ä»½æ•°æ®åº“
backup:
	@echo "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
	@docker-compose exec postgres pg_dumpall -U postgres > backup_$(shell date +%Y%m%d_%H%M%S).sql

# ç”Ÿæˆæµ‹è¯•æ•°æ®
seed:
	@echo "ğŸŒ± ç”Ÿæˆæµ‹è¯•æ•°æ®..."
	@curl -X POST http://localhost:8001/api/users/register \
		-H "Content-Type: application/json" \
		-d '{"username":"testuser","email":"test@example.com","password":"password123","phone":"13800138000"}'

# æ€§èƒ½æµ‹è¯•
perf-test:
	@echo "âš¡ è¿è¡Œæ€§èƒ½æµ‹è¯•..."
	@ab -n 1000 -c 10 http://localhost:8080/api/plans
	@ab -n 1000 -c 10 http://localhost:8080/api/users

# å®‰å…¨æ‰«æ
security-scan:
	@echo "ğŸ”’ è¿è¡Œå®‰å…¨æ‰«æ..."
	@docker run --rm -v $(PWD):/app -w /app securecodewarrior/docker-security-scanning

# ä»£ç è´¨é‡æ£€æŸ¥
lint:
	@echo "ğŸ§¹ ä»£ç è´¨é‡æ£€æŸ¥..."
	@swiftlint lint --config .swiftlint.yml

# ç”Ÿæˆ API æ–‡æ¡£
docs:
	@echo "ğŸ“š ç”Ÿæˆ API æ–‡æ¡£..."
	@echo "API æ–‡æ¡£å°†åœ¨å„æœåŠ¡å¯åŠ¨åå¯ç”¨"
	@echo "è®¿é—® http://localhost:8080/docs æŸ¥çœ‹ API æ–‡æ¡£"

# å¼€å‘ç¯å¢ƒå¿«é€Ÿå¯åŠ¨
dev:
	@echo "ğŸ› ï¸ å¯åŠ¨å¼€å‘ç¯å¢ƒ..."
	@docker-compose up -d postgres redis consul
	@sleep 5
	@echo "åŸºç¡€è®¾æ–½å·²å¯åŠ¨ï¼Œç°åœ¨å¯ä»¥å•ç‹¬è¿è¡ŒæœåŠ¡è¿›è¡Œå¼€å‘"

# ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
prod-deploy:
	@echo "ğŸš€ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²..."
	@docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# å›æ»šéƒ¨ç½²
rollback:
	@echo "âª å›æ»šéƒ¨ç½²..."
	@kubectl rollout undo deployment/user-service -n insplan
	@kubectl rollout undo deployment/plan-service -n insplan
	@kubectl rollout undo deployment/order-service -n insplan
	@kubectl rollout undo deployment/payment-service -n insplan
	@kubectl rollout undo deployment/notification-service -n insplan

# æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
stats:
	@echo "ğŸ“Š æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ..."
	@docker stats --no-stream
